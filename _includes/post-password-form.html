<!-- Password Protection Form -->
{% if page.password %}
<div id="password-wrapper" class="w-100 d-flex justify-content-center align-items-center" style="min-height: 50vh;">
  <div class="card border-0 shadow-sm" style="max-width: 400px; margin: 3rem auto;">
    <div class="card-body text-center p-5">
      <i class="fas fa-lock fa-3x text-muted mb-4"></i>
      <h3 class="card-title mb-3">Locked Content</h3>
      <p class="card-text text-muted mb-4" style="text-align: center !important;">이 포스팅은 비밀번호로 보호되어 있습니다.<br>비밀번호를 입력하여 내용을 확인하세요.</p>
      
      <form id="password-form" onsubmit="checkPassword(event)">
        <div class="form-group mb-3">
          <input type="password" class="form-control form-control-lg text-center" id="password-input" placeholder="Password" required autocomplete="current-password">
          <div class="invalid-feedback text-left">비밀번호가 일치하지 않습니다.</div>
        </div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">확인</button>
      </form>
    </div>
  </div>
</div>

<script>
  // 비밀번호 해시 비교 로직 (SHA-256)
  // Liquid 필터를 통해 서버(빌드) 측에서 해시된 비밀번호를 주입받음
  const correctHash = "{{ page.password | sha256 }}";
  const postId = "{{ page.url }}";

  async function checkPassword(event) {
    event.preventDefault();
    const inputField = document.getElementById('password-input');
    const inputPassword = inputField.value;

    // 사용자 입력을 SHA-256으로 해싱
    const isMatch = await verifyPassword(inputPassword, correctHash);
    
    if (isMatch) {
      unlockContent();
      sessionStorage.setItem('unlocked_' + postId, 'true');
    } else {
      inputField.classList.add('is-invalid');
      inputField.value = '';
      inputField.focus();
    }
  }

  async function verifyPassword(password, hash) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex === hash;
  }

  function unlockContent() {
    const wrapper = document.getElementById('password-wrapper');
    const content = document.getElementById('protected-content');
    
    if (wrapper && content) {
      wrapper.style.display = 'none';
      content.style.display = 'block';
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (sessionStorage.getItem('unlocked_' + postId) === 'true') {
      unlockContent();
    }
  });
</script>
{% endif %}
