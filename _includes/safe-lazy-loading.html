<!-- Safe Lazy Loading for Images -->
<!-- 기존 테마를 건드리지 않는 안전한 지연 로딩 -->

<script>
(function() {
  'use strict';
  
  // Intersection Observer 지원 확인
  if (!('IntersectionObserver' in window)) {
    // 폴백: 모든 이미지를 즉시 로드
    const images = document.querySelectorAll('img[data-src]');
    images.forEach(img => {
      img.src = img.dataset.src;
      img.removeAttribute('data-src');
    });
    return;
  }
  
  // 이미지 지연 로딩 설정
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        
        // 이미지 로드
        const loadImage = () => {
          const src = img.dataset.src;
          if (src) {
            img.src = src;
            img.classList.add('loaded');
            img.removeAttribute('data-src');
          }
        };
        
        // 이미지 로드 완료 시 처리
        img.onload = () => {
          img.classList.add('fade-in');
        };
        
        // 이미지 로드 에러 시 처리
        img.onerror = () => {
          img.classList.add('error');
          console.warn('Failed to load image:', img.dataset.src);
        };
        
        loadImage();
        observer.unobserve(img);
      }
    });
  }, {
    rootMargin: '50px 0px', // 50px 전에 미리 로드
    threshold: 0.01
  });
  
  // 모든 지연 로딩 이미지에 Observer 적용
  const lazyImages = document.querySelectorAll('img[data-src]');
  lazyImages.forEach(img => {
    imageObserver.observe(img);
  });
  
  // 페이지 로드 완료 후 남은 이미지들 처리
  window.addEventListener('load', () => {
    const remainingImages = document.querySelectorAll('img[data-src]');
    remainingImages.forEach(img => {
      img.src = img.dataset.src;
      img.removeAttribute('data-src');
    });
  });
})();
</script>

<!-- Lazy Loading Styles -->
<style>
img[data-src] {
  /* 이미지가 로드되기 전에도 보이도록 opacity 1로 설정 */
  opacity: 1;
  transition: opacity 0.3s ease-in-out;
  /* 로딩 중 배경색 표시 */
  background: #f5f5f5;
}

img.loaded {
  opacity: 1;
}

img.fade-in {
  animation: fadeIn 0.5s ease-in-out;
}

img.error {
  opacity: 0.5;
  filter: grayscale(100%);
}

@keyframes fadeIn {
  from { opacity: 0.8; }
  to { opacity: 1; }
}

/* 플레이스홀더 스타일 */
.lazy-placeholder {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
</style>
