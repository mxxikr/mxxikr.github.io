<!--
  Refactor the HTML structure.
-->

{% assign _content = include.content %}

<!-- Add attribute 'hide-bullet' to the checkbox list -->

{% if _content contains '<li class="task-list-item">
  <' %} {% assign _content=_content | replace: '"task-list-item"><' , '"task-list-item" hide-bullet><' %} {% endif %}
    <!-- images -->

    {% assign IMG_TAG = '<img ' %}

{% if _content contains IMG_TAG %}
  {% assign _img_content = nil %}
  {% assign _img_snippets = _content | split: IMG_TAG %}

  {% for _img_snippet in _img_snippets %}
    {% if forloop.first %}
      {% assign _img_content = _img_snippet %}
      {% continue %}
    {% endif %}

    {% assign _width = nil %}
    {% assign _height = nil %}
    {% assign _src = nil %}

    {% assign _left = _img_snippet | split: '>' | first %}
    {% assign _tag_end_len = _left.size | plus: 1 %}
    {% assign _right = _img_snippet | slice: _tag_end_len, _img_snippet.size %}

    {% assign _left = _left | remove: ' /' %}
    {% assign _attrs = _left | split: ' ' %}

    {% for _attr in _attrs %}
    {% assign _pair = _attr | split: '=' %}
    {% if _pair.size < 2 %} {% continue %} {% endif %} {% capture _key %}{{ _pair | first }}{% endcapture %} {% capture
      _value %}{{ _pair | last | replace: '"' , '' }}{% endcapture %} {% case _key %} {% when 'width' %} {% assign
      _width=_value %} {% when 'height' %} {% assign _height=_value %} {% when 'src' %} {% assign _src=_value %} {%
      endcase %} {% if _width and _height and _src %} {% break %} {% endif %} {% endfor %} {% if _src %} {% unless _src
      contains '://' %} {% assign _first_char=_src | slice: 0, 1 %} {% if _first_char=='/' %} {% capture _final_src %}{{
      _src | relative_url }}{% endcapture %} {% else %} {% if site.img_cdn %} {% assign _src_prefix=site.img_cdn %} {%
      else %} {% assign _src_prefix=site.baseurl %} {% endif %} {% if page.img_path %} {% assign _path=page.img_path %}
      {% assign last_char=_path | slice: -1 %} {% unless last_char=='/' %} {% assign _path=_path | append: '/' %} {%
      endunless %} {% assign _src_prefix=_src_prefix | append: _path %} {% endif %} {% capture _final_src %}{{
      _src_prefix | append: _src | relative_url }}{% endcapture %} {% endif %} {% if _left contains 'src=' %} {% assign
      _src_quoted=_src | prepend: '"' | append: '"' %} {% assign _final_src_quoted=_final_src | prepend: '"' |
      append: '"' %} {% assign _left=_left | replace: _src_quoted, _final_src_quoted %} {% elsif _left
      contains 'data-src=' %} {% assign _left=_left | replace: 'data-src=' , 'src=' %} {% assign _src_quoted=_src |
      prepend: '"' | append: '"' %} {% assign _final_src_quoted=_final_src | prepend: '"' | append: '"' %} {% assign
      _left=_left | replace: _src_quoted, _final_src_quoted %} {% else %} {% assign _left=_left | prepend: 'src="' |
      append: _final_src | append: '" ' %} {% endif %} {% unless _left contains 'src=' %} {% assign _left=_left |
      prepend: 'src="' | append: _final_src | append: '" ' %} {% endunless %} {% endunless %} {% endif %} {% if _width
      and _height %} {%- capture _svg -%}
      src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 {{ _width }} {{ _height }}'%3E%3C/svg%3E"
      {%- endcapture -%} {% assign _left=_svg | append: ' ' | append: _left %} {% endif %} {% assign _left=_left |
      append: ' data-proofer-ignore' %} {% assign _img_content=_img_content | append: IMG_TAG | append: _left |
      append: '>' | append: _right %} {% endfor %} {% assign _content=_img_content %} {% endif %} <!-- Create heading
      anchors -->

      {% assign heading_levels = '2,3,4,5' | split: ',' %}
      {% assign _heading_content = _content %}

      {% for level in heading_levels %}
      {% capture mark_start %}<h{{ level }} id="{% endcapture %}
  {% capture mark_end %}</h{{ level }}>{% endcapture %}

  {% if _heading_content contains mark_start %}
    {% assign _new_content = nil %}
    {% assign heading_snippets = _heading_content | split: mark_start %}

    {% for snippet in heading_snippets %}
      {% if forloop.first %}
        {% assign _new_content = snippet %}
        {% continue %}
      {% endif %}

      {% assign id = snippet | split: '"' | first %}
      {% capture anchor %}<a href="#{{ id }}" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>{% endcapture %}

      {% assign left = snippet | split: mark_end | first %}
      {% assign right = snippet | slice: left.size, snippet.size %}
      {% assign left = left | replace: '">', '"><span class="mr-2">' | append: '</span>' %}

        {% assign _new_content = _new_content | append: mark_start | append: left | append: anchor | append: mark_end |
        append: right %}
        {% endfor %}

        {% assign _heading_content = _new_content %}
        {% endif %}
        {% endfor %}

        {% assign _content = _heading_content %}

        <!-- Wrap prompt element of blockquote with the <div> tag -->

        {% assign blockquote_start = '<blockquote class=' %}
{% assign blockquote_end = ' </blockquote>' %}
          {% assign cls_prefix = 'prompt-' %}

          {% if _content contains blockquote_start %}
          {% assign _prompt_content = nil %}
          {% assign _prompt_snippets = _content | split: blockquote_start %}

          {% for _snippet in _prompt_snippets %}
          {% if forloop.first %}
          {% assign _prompt_content = _snippet %}
          {% continue %}
          {% endif %}

          {% assign left = _snippet | split: blockquote_end | first %}
          {% assign right = _snippet | slice: left.size, _snippet.size %}
          {% assign cls_str = left | split: '>' | first %}
          {% assign cls_array = cls_str | remove: '"' | split: ' ' %}
          {% assign is_prompt = false %}

          {% for cls in cls_array %}
          {% if cls contains cls_prefix %}
          {% assign is_prompt = true %}
          {% break %}
          {% endif %}
          {% endfor %}

          {% unless is_prompt %}
          {% assign _prompt_content = _prompt_content | append: blockquote_start | append: _snippet %}
          {% continue %}
          {% endunless %}

          {% assign left = left | slice: cls_str.size, left.size %}
          {% assign left = cls_str | append: '><div' | append: left | append: '</div>' %} {% assign
            _prompt_content=_prompt_content | append: blockquote_start | append: left | append: right %} {% endfor %} {%
            assign _content=_prompt_content %} {% endif %} {{ _content }}